<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <title>HealthOS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #F0F0F5;
            --card: #FFFFFF;
            --text: #000000;
            --sub: #3C3C4399; /* Apple secondary label color */
            --blue: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --orange: #FF9500;
            --purple: #AF52DE;
            --teal: #5AC8FA;
            --cyan: #32ADE6;
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --radius-l: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: var(--font);
            background: var(--bg);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            color: var(--text);
        }

        /* --- VIEWS --- */
        .view-container { flex: 1; position: relative; overflow: hidden; }
        .view {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px 20px 120px 20px;
            display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        .view.active { display: block; opacity: 1; }

        /* --- TYPOGRAPHY --- */
        h1 { font-size: 34px; font-weight: 700; margin: 10px 0 5px 0; letter-spacing: 0.3px; }
        .subtitle { font-size: 17px; color: var(--sub); margin-bottom: 25px; line-height: 1.4; }
        h2 { font-size: 13px; color: var(--sub); text-transform: uppercase; font-weight: 600; margin: 25px 0 8px 16px; }

        /* --- CARDS & LISTS --- */
        .card {
            background: var(--card);
            border-radius: var(--radius-l);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            margin-bottom: 24px;
        }

        .list-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; height: 52px;
            background: var(--card);
            position: relative;
        }
        .list-row::after {
            content: ''; position: absolute; bottom: 0; right: 0; left: 16px;
            height: 0.5px; background: #C6C6C8;
        }
        .list-row:last-child::after { display: none; }

        .list-label { 
            font-size: 17px; font-weight: 400; color: var(--text); 
            min-width: 100px; flex-shrink: 0;
        }

        /* --- FLEX CONTAINER FOR INPUTS --- */
        .input-group {
            display: flex; 
            align-items: center; 
            justify-content: flex-end;
            flex: 1; 
            text-align: right; 
            height: 100%;
        }

        /* Base style for all inputs/spans in list */
        .list-input {
            text-align: right; 
            font-size: 17px; 
            color: var(--blue);
            border: none; 
            background: transparent; 
            font-family: inherit;
            padding: 0; 
            margin: 0;
            min-width: 50px;
        }

        /* Interactive Inputs: Full height for touch targets */
        input.list-input, select.list-select {
            height: 100%;
            width: 100%;
            flex: 1;
        }

        /* Static Text Spans: Auto height to allow centering by parent */
        span.list-input {
            height: auto;
            flex: 0 1 auto;
            display: inline-block;
        }

        .list-input::placeholder { color: #C7C7CC; }
        
        .list-unit { 
            color: #8E8E93; 
            font-size: 17px; 
            margin-left: 4px; 
            flex-shrink: 0;
            font-weight: 400;
        }
        
        .list-select {
            appearance: none; border: none; background: transparent;
            font-size: 17px; color: var(--blue); text-align-last: right;
            direction: rtl; flex: 1; font-family: inherit;
            padding-right: 0;
        }

        /* --- BUTTONS --- */
        .btn-main {
            background: var(--blue); color: white; border: none; border-radius: 14px;
            width: 100%; padding: 16px; font-size: 17px; font-weight: 600;
            cursor: pointer; margin-top: 10px;
        }
        .btn-main:active { opacity: 0.7; }
        .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--red); }
        .btn-sec { background: #E5E5EA; color: var(--text); }
        .btn-small { background: var(--blue); color: white; border: none; border-radius: 8px; padding: 6px 12px; font-size: 15px; font-weight: 600; margin-left: 10px; cursor: pointer; }

        /* --- ALERT BANNERS --- */
        .alert-banner {
            padding: 15px; border-radius: 14px; margin-bottom: 20px; display: none;
            font-size: 14px; font-weight: 500; line-height: 1.4;
            align-items: center; gap: 10px;
        }
        .alert-warn { background: #FFF8E1; color: #F57F17; border: 1px solid #FFE082; }
        .alert-recovery { background: #F3E5F5; color: #7B1FA2; border: 1px solid #E1BEE7; }

        /* --- PLAN CARDS --- */
        .plan-options { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .plan-card {
            background: var(--card); border-radius: var(--radius-l); padding: 20px;
            border: 2px solid transparent; cursor: pointer; position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.04); transition: 0.2s;
        }
        .plan-card.selected { border-color: var(--blue); background: #F2F7FF; }
        .plan-title { font-size: 19px; font-weight: 600; }
        .plan-cal { font-size: 22px; font-weight: 700; color: var(--blue); float: right;}
        .plan-desc { font-size: 14px; color: var(--sub); margin: 8px 0; display:block;}
        .plan-meta { font-size: 13px; font-weight: 500; color: var(--text); background: rgba(0,0,0,0.05); padding: 6px 10px; border-radius: 8px; display: inline-block; margin-top: 5px;}

        /* --- WIDGETS --- */
        .date-control { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .date-display { font-size: 28px; font-weight: 700; }
        .date-picker-hidden { position: absolute; opacity: 0; width: 100%; height: 100%; top:0; left:0; }

        .ring-wrapper { position: relative; width: 180px; height: 180px; margin: 10px auto 30px auto; }
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-val { font-size: 36px; font-weight: 700; line-height: 1; }
        .ring-lbl { font-size: 13px; color: var(--sub); text-transform: uppercase; font-weight: 600; margin-top: 5px; }

        /* Stats Grid - 2x2 for Dashboard */
        .stats-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 10px; 
        }
        .mini-stat { 
            background: #F2F2F7; 
            border-radius: 12px; 
            padding: 16px; 
            text-align: center; 
        }
        .mini-val { display: block; font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .mini-lbl { font-size: 11px; color: var(--sub); text-transform: uppercase; font-weight: 600; }

        /* --- CHART & TAB --- */
        .chart-controls { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-bottom: 15px; }
        .chart-seg { background: #E5E5EA; padding: 3px; border-radius: 9px; display: flex; }
        .chart-btn { padding: 6px 20px; border: none; background: transparent; border-radius: 7px; font-size: 13px; font-weight: 500; color: var(--sub); }
        .chart-btn.active { background: #FFFFFF; color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        
        .range-bar { display: flex; gap: 8px; justify-content: center; }
        .range-chip { padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; background: #E5E5EA; color: var(--sub); border: none; }
        .range-chip.active { background: var(--blue); color: white; }
        
        .custom-range-inputs { display: none; width: 100%; gap: 10px; margin-top: 5px; background: #fff; padding: 10px; border-radius: 12px; align-items: center; }
        .range-date { background: #F2F2F7; border:none; padding: 8px; border-radius: 8px; font-size: 13px; color: var(--blue); flex: 1; text-align: center; }

        /* Accordion Style */
        .accordion-header {
            padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
            background: var(--card); border-bottom: 0.5px solid #E5E5EA; cursor: pointer;
        }
        .accordion-title { font-size: 15px; color: var(--text); font-weight: 600; }
        .accordion-arrow { font-size: 12px; transition: transform 0.2s; color: var(--sub); }
        .accordion-content { display: none; background: #F9F9F9; }
        .accordion-content.open { display: block; }
        .accordion-row { display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 0.5px solid #E5E5EA; font-size: 14px; }
        .accordion-row:last-child { border-bottom: none; }
        .delete-btn-small { color: #C7C7CC; border: none; background: none; font-size: 16px; padding: 0 5px; }

        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-top: 0.5px solid #C6C6C8; display: flex; justify-content: space-around; padding-top: 10px; padding-bottom: var(--safe-bottom); z-index: 1000; }
        .tab-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; width: 60px; }
        .tab-icon { font-size: 24px; filter: grayscale(100%) opacity(0.4); transition: 0.2s; }
        .tab-label { font-size: 10px; font-weight: 500; color: var(--sub); }
        .tab-btn.active .tab-icon { filter: none; transform: scale(1.1); color: var(--blue); opacity: 1; }
        .tab-btn.active .tab-label { color: var(--blue); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body>

    <div class="view-container">

        <!-- 1. SETUP VIEW -->
        <div id="view-setup" class="view">
            <div style="margin-top: 40px;"><h1>Setup Profile</h1><p class="subtitle">Enter your details to generate your plan.</p></div>
            <h2>Biometrics</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Sex</span><div class="input-group"><select id="setupSex" class="list-select"><option value="male">Male</option><option value="female">Female</option></select></div></div>
                <div class="list-row"><span class="list-label">Age</span><div class="input-group"><input type="tel" id="setupAge" class="list-input" placeholder="0"><span class="list-unit">yrs</span></div></div>
                <div class="list-row"><span class="list-label">Height</span><div class="input-group"><input type="tel" id="setupHeight" class="list-input" placeholder="0"><span class="list-unit">cm</span></div></div>
                <div class="list-row"><span class="list-label">Weight</span><div class="input-group"><input type="text" inputmode="decimal" id="setupWeight" class="list-input" placeholder="0.0" onblur="formatFloat(this)"><span class="list-unit">kg</span></div></div>
            </div>
            <h2>Goals</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Activity</span><div class="input-group"><select id="setupActivity" class="list-select"><option value="1.2">Sedentary (Office)</option><option value="1.375">Light (1-3 days)</option><option value="1.55">Moderate (3-5 days)</option><option value="1.725">Active (6-7 days)</option></select></div></div>
                <div class="list-row"><span class="list-label">Target</span><div class="input-group"><input type="text" inputmode="decimal" id="setupTarget" class="list-input" placeholder="0.0" onblur="formatFloat(this)"><span class="list-unit">kg</span></div></div>
            </div>
            <button class="btn-main" onclick="revealPlans()">Analyze & Create Plans</button>
            <div id="plan-selector" style="display:none; margin-top: 40px; padding-bottom: 50px;"><h1>Select Pace</h1><p class="subtitle">Choose a sustainable path.</p><div class="plan-options" id="planOptionsContainer"></div></div>
        </div>

        <!-- 2. DASHBOARD VIEW -->
        <div id="view-dash" class="view">
            <div class="date-control" style="position:relative;">
                <div><div style="font-size:13px; color:var(--sub); font-weight:600; text-transform:uppercase;">Overview</div><div class="date-display" id="dashDateDisp">Today</div></div>
                <div style="color:var(--blue); font-size:17px; font-weight:600;">üìÖ</div>
                <input type="date" id="dashDate" class="date-picker-hidden" onchange="dateChanged()">
            </div>

            <div id="alertArea">
                <div id="gapAlert" class="alert-banner alert-warn"><span>‚ö†Ô∏è</span><span>Missing logs in last 7 days.</span></div>
                <div id="recoveryAlert" class="alert-banner alert-recovery"><span>üç∑</span><span>Recovery Mode: +15% Activity Goal.</span></div>
            </div>

            <div class="card" style="padding: 25px 20px;">
                <div class="ring-wrapper"><canvas id="calRing"></canvas><div class="ring-center"><div class="ring-val" id="dispRem">0</div><div class="ring-lbl">Left</div></div></div>
                <div class="stats-grid">
                    <div class="mini-stat"><span class="mini-val" id="dispTDEE" style="color:var(--text)">0</span><span class="mini-lbl">Daily Need (Burn)</span></div>
                    <div class="mini-stat"><span class="mini-val" id="dispGoal" style="color:var(--blue)">0</span><span class="mini-lbl">Target Intake</span></div>
                    <div class="mini-stat"><span class="mini-val" id="dispEaten" style="color:var(--orange)">0</span><span class="mini-lbl">Actual Intake</span></div>
                    <div class="mini-stat"><span class="mini-val" id="dispRealDeficit" style="color:var(--green)">0</span><span class="mini-lbl">Real Deficit</span></div>
                </div>
                <!-- Water Total -->
                <div style="margin-top:15px; text-align:center; padding-top:15px; border-top:1px solid #E5E5EA;">
                    <span style="font-size:18px; font-weight:700; color:var(--cyan);" id="dispWaterMain">0</span>
                    <span style="font-size:11px; color:var(--sub); text-transform:uppercase; font-weight:600; display:block;">Water (Actual / Target)</span>
                </div>
            </div>

            <h2>Log Intake</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Weight</span><div class="input-group"><input type="text" inputmode="decimal" id="logWeight" class="list-input" placeholder="0.0" onblur="formatFloat(this); saveLog();"><span class="list-unit">kg</span></div></div>
                <div class="list-row"><span class="list-label">Breakfast</span><div class="input-group"><input type="number" id="m1" class="list-input meal" placeholder="0" inputmode="decimal"><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Snack 1</span><div class="input-group"><input type="number" id="m2" class="list-input meal" placeholder="0" inputmode="decimal"><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Lunch</span><div class="input-group"><input type="number" id="m3" class="list-input meal" placeholder="0" inputmode="decimal"><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Snack 2</span><div class="input-group"><input type="number" id="m4" class="list-input meal" placeholder="0" inputmode="decimal"><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Dinner</span><div class="input-group"><input type="number" id="m5" class="list-input meal" placeholder="0" inputmode="decimal"><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Exercise</span><div class="input-group"><input type="number" id="logAct" class="list-input meal" placeholder="0" inputmode="decimal" style="color:var(--green);"><span class="list-unit">kcal</span></div></div>
            </div>

            <h2>Hydration</h2>
            <div class="card">
                 <div class="list-row">
                    <span class="list-label">Total / Target</span>
                    <div class="input-group">
                        <span class="list-input" style="color:var(--cyan); font-weight:700;" id="waterTotal">0</span>
                        <span class="list-unit">ml</span>
                    </div>
                 </div>
                 <div class="list-row">
                    <span class="list-label">Add Water</span>
                    <div class="input-group">
                        <input type="number" id="waterInput" class="list-input" placeholder="e.g. 250">
                        <span class="list-unit">ml</span>
                        <button class="btn-small" onclick="addWater()">+</button>
                    </div>
                 </div>
                 <!-- Accordion for Water History -->
                 <div class="accordion-header" onclick="toggleWaterList()">
                     <span class="accordion-title">Today's Intakes</span>
                     <span class="accordion-arrow" id="waterArrow">‚ñº</span>
                 </div>
                 <div id="waterList" class="accordion-content">
                     <!-- Entries go here -->
                 </div>
            </div>

            <h2>Alcohol</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Type</span><div class="input-group"><select id="alcType" class="list-select" onchange="saveLog()"><option value="None">None</option><option value="Vodka">Vodka/Whiskey</option><option value="Beer">Beer</option><option value="Wine">Wine</option><option value="Cocktail">Cocktail</option></select></div></div>
                <div class="list-row"><span class="list-label">Amount</span><div class="input-group"><input type="number" id="alcVol" class="list-input" placeholder="0" inputmode="decimal" onchange="saveLog()"><span class="list-unit">ml</span></div></div>
                <div class="list-row"><span class="list-label">Calories</span><div class="input-group"><span class="list-input" style="color:var(--purple); font-weight:600;" id="alcKcal">0</span><span class="list-unit">kcal</span></div></div>
            </div>
            
            <div id="statusMessage" style="text-align: center; color: var(--sub); font-size: 13px; font-weight:500;"></div>
            <button class="btn-main btn-danger" id="btnDeleteLog" style="display:none; margin-top:20px;" onclick="deleteCurrentLog()">Delete This Log</button>
        </div>

        <!-- 3. STATS VIEW -->
        <div id="view-stats" class="view">
            <h1>Trends</h1>
            <div class="chart-controls">
                <div class="chart-seg">
                    <button class="chart-btn active" id="btnModeWeight" onclick="setChartMode('weight')">Weight</button>
                    <button class="chart-btn" id="btnModeEnergy" onclick="setChartMode('energy')">Energy</button>
                    <button class="chart-btn" id="btnModeWater" onclick="setChartMode('water')">Water</button>
                </div>
                <div class="range-bar">
                    <button class="range-chip active" id="rng1M" onclick="setChartRange('1M')">1M</button>
                    <button class="range-chip" id="rng3M" onclick="setChartRange('3M')">3M</button>
                    <button class="range-chip" id="rng6M" onclick="setChartRange('6M')">6M</button>
                    <button class="range-chip" id="rngCust" onclick="setChartRange('Custom')">Cust</button>
                </div>
                <div id="custom-range-picker" class="custom-range-inputs">
                    <input type="date" id="custStart" class="range-date" onchange="loadStats()">
                    <span style="color:var(--sub)">to</span>
                    <input type="date" id="custEnd" class="range-date" onchange="loadStats()">
                </div>
            </div>

            <div class="card" style="padding: 20px;">
                <div class="chart-container" style="height:250px; position:relative; width:100%">
                    <canvas id="weightChart"></canvas>
                </div>
                <div style="text-align:center; font-size:12px; color:var(--sub); margin-top:5px;" id="chartRangeLabel"></div>
            </div>

            <h2>Performance</h2>
            <div class="card" style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; border-bottom: 0.5px solid #E5E5EA; padding-bottom: 15px; margin-bottom: 15px;">
                    <div style="text-align: center; flex:1;">
                        <span style="display:block; font-size: 11px; color:var(--sub); text-transform:uppercase; font-weight:600;">Scale Loss</span>
                        <span style="font-size: 20px; font-weight:700; color:var(--blue);" id="statLost">0</span> <span style="font-size:14px; color:var(--sub);">kg</span>
                    </div>
                    <div style="text-align: center; flex:1; border-left: 0.5px solid #E5E5EA;">
                        <span style="display:block; font-size: 11px; color:var(--sub); text-transform:uppercase; font-weight:600;">Expected</span>
                        <span style="font-size: 20px; font-weight:700; color:var(--purple);" id="statPred">0</span> <span style="font-size:14px; color:var(--sub);">kg</span>
                    </div>
                    <div style="text-align: center; flex:1; border-left: 0.5px solid #E5E5EA;">
                        <span style="display:block; font-size: 11px; color:var(--sub); text-transform:uppercase; font-weight:600;">To Go</span>
                        <span style="font-size: 20px; font-weight:700; color:var(--orange);" id="statRem">0</span> <span style="font-size:14px; color:var(--sub);">kg</span>
                    </div>
                </div>
                <div style="text-align:center;">
                    <span style="font-size:14px; color:var(--text); font-weight:500;" id="statDiff">Efficiency: --%</span>
                </div>
            </div>

            <h2>History <span style="font-size:12px; color:var(--sub); font-weight:400; text-transform:none;">(Tap to Edit)</span></h2>
            <div id="historyList"></div>
        </div>

        <!-- 4. PROFILE VIEW -->
        <div id="view-profile" class="view">
            <h1>Profile</h1>
            <h2>Current Plan</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Type</span><div class="input-group"><div class="input-group"><select id="profPlanSelect" class="list-select" onchange="updateProfile()"><option value="Mild">Mild</option><option value="Balanced">Balanced</option><option value="Intense">Intense</option></select></div></div></div>
                <div class="list-row"><span class="list-label">Base Budget</span><div class="input-group"><span class="list-input" style="color:var(--blue); font-weight:700;" id="profBudget">0</span><span class="list-unit">kcal</span></div></div>
                <div class="list-row"><span class="list-label">Target Date</span><div class="input-group"><span class="list-input" style="color:var(--sub);" id="profDate">--</span></div></div>
            </div>
            <h2>Stats</h2>
            <div class="card">
                <div class="list-row"><span class="list-label">Weight</span><div class="input-group"><input type="text" inputmode="decimal" id="profWeight" class="list-input" onblur="formatFloat(this); updateProfile()"><span class="list-unit">kg</span></div></div>
                <div class="list-row"><span class="list-label">Goal</span><div class="input-group"><input type="text" inputmode="decimal" id="profGoal" class="list-input" onblur="formatFloat(this); updateProfile()"><span class="list-unit">kg</span></div></div>
            </div>
            <h2>Data</h2>
            <button class="btn-main" onclick="exportData()">Backup</button>
            <div style="margin-top:10px;"><input type="file" id="importFile" style="display:none" onchange="importData(this)"><button class="btn-main btn-sec" onclick="document.getElementById('importFile').click()">Restore</button></div>
            <button class="btn-main btn-danger" onclick="resetApp()" style="margin-top:30px;">Reset App</button>
        </div>
    </div>

    <!-- === TAB BAR === -->
    <div class="tab-bar" id="tabBar" style="display: none;">
        <button class="tab-btn active" onclick="nav('dash', this)"><span class="tab-icon">‚¶ø</span><span class="tab-label">Today</span></button>
        <button class="tab-btn" onclick="nav('stats', this)"><span class="tab-icon">üìà</span><span class="tab-label">Trends</span></button>
        <button class="tab-btn" onclick="nav('profile', this)"><span class="tab-icon">üë§</span><span class="tab-label">Profile</span></button>
    </div>

<script>
    const KEY = 'healthos_v23_final_qa';
    let db = { user: null, logs: {}, settings: { chartMode: 'weight', chartRange: '1M', customStart: null, customEnd: null } };
    let currentDateKey = new Date().toISOString().split('T')[0];
    let selectedPlanIndex = -1;
    let tempPlans = [];
    let weightChartInstance = null;
    let ringChart = null; 
    let chartMode = 'weight'; 
    let chartRange = '1M';

    const PLANS = {
        'Mild': { def: 250, loss: 0.25 },
        'Balanced': { def: 500, loss: 0.5 },
        'Intense': { def: 1000, loss: 1.0 }
    };

    const alcFactor = {'Vodka': 2.3, 'Beer': 0.43, 'Wine': 0.85, 'Cocktail': 1.8, 'None': 0};

    function formatDate(dateStr) {
        if (!dateStr) return '--';
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = d.toLocaleDateString('en-US', { month: 'short' });
        const year = String(d.getFullYear()).slice(-2);
        return `${day}/${month}/${year}`;
    }

    function formatFloat(input) {
        if (!input.value) return;
        let val = input.value.replace(',', '.');
        if (!isNaN(val)) input.value = val;
    }
    function parseVal(val) {
        if (!val) return 0;
        if (typeof val === 'number') return val;
        return parseFloat(val.replace(',', '.')) || 0;
    }

    window.onload = () => {
        const saved = localStorage.getItem(KEY);
        if (saved) {
            db = JSON.parse(saved);
            if(!db.settings) db.settings = { chartMode: 'weight', chartRange: '1M' };
        }
        
        document.getElementById('dashDate').value = currentDateKey;

        if(!db.settings.customEnd) {
             const d = new Date(); 
             document.getElementById('custEnd').value = d.toISOString().split('T')[0];
             if(db.user && db.user.startDate) {
                 document.getElementById('custStart').value = db.user.startDate;
             } else {
                 d.setMonth(d.getMonth()-1); 
                 document.getElementById('custStart').value = d.toISOString().split('T')[0];
             }
        } else {
            document.getElementById('custStart').value = db.settings.customStart;
            document.getElementById('custEnd').value = db.settings.customEnd;
        }

        if (!db.user) showView('setup');
        else {
            document.getElementById('tabBar').style.display = 'flex';
            loadDashboard(); 
            showView('dash');
        }
        document.querySelectorAll('.meal').forEach(el => el.addEventListener('input', saveLog));
    };

    function nav(view, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        if(view === 'dash') loadDashboard();
        if(view === 'stats') {
            updateChartUI();
            loadStats();
        }
        if(view === 'profile') loadProfile();
        showView(view);
    }
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
    }

    // --- DASHBOARD ---
    function dateChanged() {
        currentDateKey = document.getElementById('dashDate').value;
        loadDashboard();
    }

    function checkGaps() {
        if (!db.user || !db.user.startDate) return;
        const today = new Date(); const start = db.user.startDate;
        let gaps = 0;
        for (let i=1; i<=7; i++) {
            const d = new Date(today); d.setDate(today.getDate()-i);
            const k = d.toISOString().split('T')[0];
            if (k >= start && !db.logs[k]) gaps++;
        }
        document.getElementById('gapAlert').style.display = gaps > 0 ? 'flex' : 'none';
    }

    function checkRecovery() {
        const t = new Date(currentDateKey); t.setDate(t.getDate()-1);
        const k = t.toISOString().split('T')[0];
        const log = db.logs[k];
        document.getElementById('recoveryAlert').style.display = (log && log.alc && log.alc.kcal > 0) ? 'flex' : 'none';
    }

    function loadDashboard() {
        const log = db.logs[currentDateKey] || { weight:'', m:[0,0,0,0,0], act:0, alc:{type:'None',vol:0,kcal:0}, water:0, waterEntries:[] };
        const u = db.user;
        let bmr = (10*u.currentWeight)+(6.25*u.height)-(5*u.age)+(u.sex==='male'?5:-161);
        let tdee = Math.round(bmr*u.activity);
        let budget = Math.round(tdee - (u.targetDeficit||500));
        const min = u.sex==='male'?1500:1200; if(budget<min) budget=min;

        // Water Target Logic (33ml per kg)
        const waterTarget = Math.round(u.currentWeight * 33);
        const waterActual = log.water || 0;

        if(currentDateKey === new Date().toISOString().split('T')[0]) { checkGaps(); checkRecovery(); }
        else { document.getElementById('gapAlert').style.display='none'; document.getElementById('recoveryAlert').style.display='none'; }

        document.getElementById('dashDateDisp').innerText = formatDate(currentDateKey);
        
        document.getElementById('logWeight').value = log.weight||'';
        for(let i=0;i<5;i++) document.getElementById('m'+(i+1)).value = log.m[i]||'';
        document.getElementById('logAct').value = log.act||'';
        
        document.getElementById('waterTotal').innerText = `${waterActual} / ${waterTarget}`;
        document.getElementById('dispWaterMain').innerText = `${waterActual} / ${waterTarget}`;
        renderWaterList(log.waterEntries || []);

        if(log.alc) {
            document.getElementById('alcType').value = log.alc.type;
            document.getElementById('alcVol').value = log.alc.vol||'';
            document.getElementById('alcKcal').innerText = Math.round(log.alc.kcal);
        } else {
            document.getElementById('alcType').value = 'None';
            document.getElementById('alcVol').value = '';
            document.getElementById('alcKcal').innerText = 0;
        }

        const food = (log.m||[]).reduce((a,b)=>a+b,0);
        const totalIn = Math.round(food + (log.alc?log.alc.kcal:0));
        const burned = Math.round(log.act||0);
        const totalBurn = tdee + burned;
        const totalBudget = Math.round(budget + burned);
        const rem = Math.round(totalBudget - totalIn);
        const realDeficit = Math.round(totalBurn - totalIn);

        document.getElementById('dispTDEE').innerText = totalBurn;
        document.getElementById('dispGoal').innerText = totalBudget;
        document.getElementById('dispEaten').innerText = totalIn;
        document.getElementById('dispRealDeficit').innerText = realDeficit;
        
        const rEl = document.getElementById('dispRem');
        rEl.innerText = rem;
        rEl.style.color = rem<0?'var(--red)':'var(--text)';
        
        document.getElementById('statusMessage').innerText = rem<0 ? `${Math.abs(rem)} kcal over.` : "On track.";
        document.getElementById('btnDeleteLog').style.display = db.logs[currentDateKey] ? 'block' : 'none';

        renderRing(totalIn, totalBudget);
    }

    function toggleWaterList() {
        const content = document.getElementById('waterList');
        const arrow = document.getElementById('waterArrow');
        if (content.style.display === 'block') {
            content.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
        } else {
            content.style.display = 'block';
            arrow.style.transform = 'rotate(180deg)';
        }
    }

    function renderWaterList(entries) {
        const container = document.getElementById('waterList');
        container.innerHTML = '';
        if(!entries || entries.length === 0) {
            container.innerHTML = '<div style="padding:10px 16px; color:#8E8E93;">No records</div>';
            return;
        }
        
        entries.forEach((amount, index) => {
            const div = document.createElement('div');
            div.className = 'accordion-row';
            div.innerHTML = `
                <span>${amount} ml</span>
                <button class="delete-btn-small" onclick="deleteWaterEntry(${index})">√ó</button>
            `;
            container.appendChild(div);
        });
    }

    function addWater() {
        const amount = Number(document.getElementById('waterInput').value);
        if (!amount || amount <= 0) return;
        
        let log = db.logs[currentDateKey] || { weight:'', m:[0,0,0,0,0], act:0, alc:{type:'None',vol:0,kcal:0}, water:0, waterEntries:[] };
        
        if(!log.waterEntries) log.waterEntries = [];
        if(log.water > 0 && log.waterEntries.length === 0) {
            log.waterEntries.push(log.water);
        }

        log.waterEntries.push(amount);
        log.water = log.waterEntries.reduce((a,b)=>a+b, 0); 
        
        if(!db.logs[currentDateKey]) { if(!log.m) log.m=[0,0,0,0,0]; }
        
        db.logs[currentDateKey] = log;
        saveDB();
        document.getElementById('waterInput').value = '';
        loadDashboard();
        document.getElementById('waterList').style.display = 'block';
        document.getElementById('waterArrow').style.transform = 'rotate(180deg)';
    }

    function deleteWaterEntry(index) {
        let log = db.logs[currentDateKey];
        if(log && log.waterEntries) {
            log.waterEntries.splice(index, 1);
            log.water = log.waterEntries.reduce((a,b)=>a+b, 0);
            saveDB();
            loadDashboard();
        }
    }

    function saveLog() {
        const wStr = document.getElementById('logWeight').value;
        const weight = parseVal(wStr);
        const m = [1,2,3,4,5].map(i=>Number(document.getElementById('m'+i).value)||0);
        const act = Number(document.getElementById('logAct').value)||0;
        const at = document.getElementById('alcType').value;
        const av = Number(document.getElementById('alcVol').value)||0;
        const ak = Math.round(av * (alcFactor[at]||0));
        document.getElementById('alcKcal').innerText = ak;
        
        const exist = db.logs[currentDateKey] || {};
        const wat = exist.water || 0;
        const watEnt = exist.waterEntries || [];

        db.logs[currentDateKey] = { 
            weight: (weight>0?weight:exist.weight), m, act, 
            alc:{type:at, vol:av, kcal:ak}, 
            total: m.reduce((a,b)=>a+b,0)+ak, 
            water: wat, waterEntries: watEnt 
        };
        
        if(currentDateKey >= new Date().toISOString().split('T')[0] && weight > 0) db.user.currentWeight = weight;
        saveDB(); loadDashboard();
    }

    function deleteCurrentLog() {
        if(confirm("Delete log?")) { delete db.logs[currentDateKey]; saveDB(); loadDashboard(); }
    }

    function renderRing(curr, max) {
        const ctx = document.getElementById('calRing').getContext('2d');
        if(ringChart) ringChart.destroy();
        const color = curr > max ? '#FF3B30' : '#007AFF';
        const rem = Math.max(0, max - curr);
        ringChart = new Chart(ctx, {
            type: 'doughnut',
            data: { datasets: [{ data: [curr, rem], backgroundColor: [color, '#E5E5EA'], borderWidth: 0, borderRadius: 20 }] },
            options: { cutout: '85%', responsive: true, animation: false, plugins: { legend: { display: false } } }
        });
    }

    // --- CHART & STATS ---
    function setChartMode(m) { 
        db.settings.chartMode = m; 
        saveDB(); 
        updateChartUI(); 
        renderChart(); 
    }
    
    function setChartRange(r) { 
        db.settings.chartRange = r; 
        if(r === 'Custom') {
             db.settings.customStart = document.getElementById('custStart').value;
             db.settings.customEnd = document.getElementById('custEnd').value;
        }
        saveDB(); 
        updateChartUI(); 
        renderChart(); 
    }

    function updateChartUI() {
        const m = db.settings.chartMode;
        const r = db.settings.chartRange;

        ['btnModeWeight','btnModeEnergy','btnModeWater'].forEach(id=>document.getElementById(id).classList.remove('active'));
        let modeId = 'btnModeWeight';
        if(m === 'energy') modeId = 'btnModeEnergy';
        if(m === 'water') modeId = 'btnModeWater';
        document.getElementById(modeId).classList.add('active');
        
        ['rng1M','rng3M','rng6M','rngCust'].forEach(id=>document.getElementById(id).classList.remove('active'));
        let aid='rng1M'; if(r==='3M')aid='rng3M'; if(r==='6M')aid='rng6M'; if(r==='Custom')aid='rngCust';
        document.getElementById(aid).classList.add('active');
        
        if(r === 'Custom' && !document.getElementById('custStart').value) {
             document.getElementById('custStart').value = db.user.startDate;
        }

        document.getElementById('custom-range-picker').style.display = r==='Custom'?'flex':'none';
    }

    function loadStats() {
        const u = db.user;
        const actualLoss = u.startWeight - u.currentWeight;
        const toGo = (u.currentWeight - u.goalWeight);
        
        const start = new Date(u.startDate);
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        const planDeficit = u.targetDeficit || 500;
        const predictedLoss = (diffDays * planDeficit) / 7700;
        
        const efficiency = predictedLoss > 0 ? (actualLoss / predictedLoss) * 100 : 0;

        document.getElementById('statLost').innerText = actualLoss.toFixed(1);
        document.getElementById('statPred').innerText = predictedLoss.toFixed(1);
        document.getElementById('statRem').innerText = toGo.toFixed(1);
        
        let msg = "On Track";
        if(efficiency < 80) msg = "Slower";
        if(efficiency > 120) msg = "Faster";
        document.getElementById('statDiff').innerText = `Efficiency: ${Math.round(efficiency)}% (${msg})`;

        const list = document.getElementById('historyList'); list.innerHTML='';
        const keys = Object.keys(db.logs).sort().reverse().slice(0,10);
        keys.forEach(d => {
            const l = db.logs[d];
            const div = document.createElement('div'); div.className='card'; div.style.padding='15px'; div.style.marginBottom='10px'; div.style.cursor='pointer';
            div.onclick=()=>{ document.getElementById('dashDate').value=d; currentDateKey=d; nav('dash'); };
            div.innerHTML = `<div style="display:flex; justify-content:space-between"><span style="color:var(--sub); font-weight:600">${formatDate(d)}</span><span style="font-weight:700">${l.weight?l.weight+'kg':'--'}</span><span style="color:var(--blue)">${Math.round(l.total||0)} kcal</span></div>`;
            list.appendChild(div);
        });
        renderChart();
    }

    function renderChart() {
        const ctx = document.getElementById('weightChart').getContext('2d');
        if(weightChartInstance) weightChartInstance.destroy();

        let start = new Date(); let end = new Date();
        const r = db.settings.chartRange;
        const m = db.settings.chartMode;

        if(r==='1M') start.setMonth(end.getMonth()-1);
        else if(r==='3M') start.setMonth(end.getMonth()-3);
        else if(r==='6M') start.setMonth(end.getMonth()-6);
        else if(r==='Custom') { 
            start=new Date(document.getElementById('custStart').value); 
            end=new Date(document.getElementById('custEnd').value); 
            db.settings.customStart = document.getElementById('custStart').value;
            db.settings.customEnd = document.getElementById('custEnd').value;
            saveDB();
        }

        document.getElementById('chartRangeLabel').innerText = `${formatDate(start)} - ${formatDate(end)}`;
        const sStr = start.toISOString().split('T')[0]; const eStr = end.toISOString().split('T')[0];
        const allKeys = Object.keys(db.logs).sort();
        const rangeKeys = allKeys.filter(d => d>=sStr && d<=eStr);

        let lbls=[], dataset1=[], dataset2=[];
        const u = db.user;

        lbls = rangeKeys.map(d=>formatDate(d).slice(0,6));

        if(m === 'weight') {
            dataset1 = rangeKeys.map(d=>db.logs[d].weight || null);
            const planLossPerDay = (db.user.targetDeficit || 500) / 7700;
            const startObj = new Date(db.user.startDate);
            dataset2 = rangeKeys.map(d => {
                const dayObj = new Date(d);
                const diffDays = Math.floor((dayObj - startObj) / (1000 * 60 * 60 * 24));
                return (db.user.startWeight - (diffDays * planLossPerDay)).toFixed(1);
            });

            weightChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: lbls,
                    datasets: [
                        { label: 'Actual', data: dataset1, borderColor: '#007AFF', borderWidth: 3, pointRadius: 3, tension: 0.3 },
                        { label: 'Predicted', data: dataset2, borderColor: '#AF52DE', borderWidth: 2, pointRadius: 0, borderDash: [5,5] }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    scales:{
                        x:{grid:{display:false}},
                        y:{title:{display:true, text:'kg'}, ticks: { stepSize: 0.1 }}
                    } 
                }
            });

        } else if (m === 'energy') {
            dataset1 = rangeKeys.map(d=> Math.round(db.logs[d].total || 0));
            let tooltipBurns=[], tooltipIntakes=[], tooltipDeficits=[];

            dataset2 = rangeKeys.map(d => {
                let bmr = (10*u.currentWeight)+(6.25*u.height)-(5*u.age)+(u.sex==='male'?5:-161);
                let tdee = Math.round(bmr*u.activity);
                let dailyBurn = tdee + (db.logs[d].act || 0);
                tooltipBurns.push(dailyBurn);
                const dailyIntake = Math.round(db.logs[d].total || 0);
                tooltipIntakes.push(dailyIntake);
                tooltipDeficits.push(dailyBurn - dailyIntake);
                return dailyBurn;
            });
            const barColors = dataset1.map((val, i) => val > dataset2[i] ? '#FF3B30' : '#34C759');

            weightChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lbls,
                    datasets: [
                        { type: 'line', label: 'Burn Limit', data: dataset2, borderColor: '#007AFF', borderWidth: 2, pointRadius: 0 },
                        { type: 'bar', label: 'Intake', data: dataset1, backgroundColor: barColors, borderRadius: 4 }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    scales:{x:{grid:{display:false}},y:{title:{display:true, text:'kcal'}}},
                    plugins: { tooltip: { callbacks: { label: (c) => {
                        if(c.dataset.label==='Intake') {
                            const i = c.dataIndex;
                            return [`Daily Need: ${tooltipBurns[i]}`, `Intake: ${tooltipIntakes[i]}`, tooltipDeficits[i] > 0 ? `Deficit: ${tooltipDeficits[i]}` : `Over: ${Math.abs(tooltipDeficits[i])}`];
                        }
                        return `${c.dataset.label}: ${c.raw}`;
                    }}}}
                }
            });
        } else if (m === 'water') {
            dataset1 = rangeKeys.map(d=> db.logs[d].water || 0);
            
            // Generate Target Data for Line
            // Recalculate target historically based on logged weight if available, or current
            dataset2 = rangeKeys.map(d => {
                const dayWeight = db.logs[d].weight || u.currentWeight;
                return Math.round(dayWeight * 33);
            });

            weightChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lbls,
                    datasets: [
                        { type: 'line', label: 'Target', data: dataset2, borderColor: '#32ADE6', borderWidth: 2, pointRadius: 0, borderDash: [5,5] },
                        { type: 'bar', label: 'Actual', data: dataset1, backgroundColor: '#5AC8FA', borderRadius: 4 }
                    ]
                },
                options: { 
                    responsive:true, maintainAspectRatio:false, 
                    scales:{x:{grid:{display:false}},y:{title:{display:true, text:'ml'}}},
                    plugins: { tooltip: { callbacks: { label: (c) => {
                        return `${c.dataset.label}: ${c.raw} ml`;
                    }}}}
                }
            });
        }
    }

    // --- SETUP & UTILS ---
    function revealPlans() {
        const w=parseVal(document.getElementById('setupWeight').value);
        const t=parseVal(document.getElementById('setupTarget').value);
        if(!w||!t) return alert("Fill fields");
        const s=document.getElementById('setupSex').value;
        const bmr=(10*w)+(6.25*Number(document.getElementById('setupHeight').value))-(5*Number(document.getElementById('setupAge').value))+(s==='male'?5:-161);
        const tdee=Math.round(bmr*Number(document.getElementById('setupActivity').value));
        const diff=w-t;
        tempPlans=[{name:"Mild", def:250, desc:"Slow & steady", col:"var(--teal)", loss:0.25},{name:"Balanced", def:500, desc:"Recommended", col:"var(--blue)", loss:0.5},{name:"Intense", def:1000, desc:"Fast results", col:"var(--purple)", loss:1.0}];
        const con=document.getElementById('planOptionsContainer'); con.innerHTML='';
        tempPlans.forEach((p,i) => {
            let bud = tdee - p.def; const min = s==='male'?1500:1200; if(bud<min) bud=min;
            const wks = diff/p.loss; const d = new Date(); d.setDate(d.getDate()+(wks*7));
            const div=document.createElement('div'); div.className='plan-card fade-in'; div.style.animationDelay=(i*0.1)+'s';
            div.onclick=()=>selPlan(i,div);
            div.innerHTML=`<div class="plan-header"><span class="plan-title" style="color:${p.col}">${p.name}</span><span class="plan-cal">${Math.round(bud)} <span style="font-size:14px;color:var(--sub)">kcal</span></span></div><div class="plan-desc">${p.desc}</div><div class="plan-meta"><div class="meta-tag">üìâ -${p.loss}kg/wk</div><div class="meta-tag">üèÅ ${formatDate(d)}</div></div>`;
            con.appendChild(div);
        });
        document.getElementById('plan-selector').style.display='block';
        document.getElementById('plan-selector').scrollIntoView({behavior:'smooth'});
    }
    function selPlan(i, el) { selectedPlanIndex=i; document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); if(!document.getElementById('btnConfirm')) { const b=document.createElement('button'); b.id='btnConfirm'; b.className='btn-main fade-in'; b.innerText='Start Journey'; b.onclick=finishSetup; document.getElementById('plan-selector').appendChild(b); } }
    function finishSetup() {
        const w=parseVal(document.getElementById('setupWeight').value);
        db.user={sex:document.getElementById('setupSex').value, age:Number(document.getElementById('setupAge').value), height:Number(document.getElementById('setupHeight').value), activity:Number(document.getElementById('setupActivity').value), startWeight:w, currentWeight:w, goalWeight:parseVal(document.getElementById('setupTarget').value), planType:tempPlans[selectedPlanIndex].name, targetDeficit:tempPlans[selectedPlanIndex].def, startDate:new Date().toISOString().split('T')[0]};
        saveDB(); document.getElementById('tabBar').style.display='flex'; loadDashboard(); showView('dash');
    }
    function saveDB() { localStorage.setItem(KEY, JSON.stringify(db)); }
    function loadProfile() {
        const u=db.user; 
        const select = document.getElementById('profPlanSelect');
        if (select) { select.value = u.planType; }
        let bmr=(10*u.currentWeight)+(6.25*u.height)-(5*u.age)+(u.sex==='male'?5:-161);
        let bud=Math.round(bmr*u.activity)-(u.targetDeficit||500); const min=u.sex==='male'?1500:1200; if(bud<min) bud=min;
        document.getElementById('profBudget').innerText=bud;
        let rate=0.5; 
        if(u.planType==='Mild')rate=0.25; 
        if(u.planType==='Intense')rate=1.0;
        const wks=(u.currentWeight-u.goalWeight)/rate; const d=new Date(); d.setDate(d.getDate()+(wks*7));
        document.getElementById('profDate').innerText=formatDate(d);
        document.getElementById('profWeight').value=u.currentWeight; document.getElementById('profGoal').value=u.goalWeight;
    }
    function updateProfile() { 
        db.user.currentWeight=parseVal(document.getElementById('profWeight').value); 
        db.user.goalWeight=parseVal(document.getElementById('profGoal').value); 
        const newPlan = document.getElementById('profPlanSelect').value;
        if(newPlan && PLANS[newPlan]) { db.user.planType = newPlan; db.user.targetDeficit = PLANS[newPlan].def; }
        saveDB(); loadProfile(); 
    }
    function exportData() { const b=new Blob([JSON.stringify(db)],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="backup.json"; a.click(); }
    function importData(inp) { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{ db=JSON.parse(e.target.result); saveDB(); alert("Restored!"); location.reload(); }catch(err){alert("Error");} }; r.readAsText(f); }
    function resetApp() { if(confirm("Reset?")) { localStorage.removeItem(KEY); location.reload(); } }
</script>
</body>
</html>
